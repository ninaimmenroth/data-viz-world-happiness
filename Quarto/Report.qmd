---
title: "Data Visualization Project 2: Analysis of the World Happiness Dataset"
author: "Caroline Graebel, Nina Immenroth, Bogdan Kostić, Naim Zahari"
format:
  html:
    embed-resources: true
    number-sections: true
    toc: true
    toc_float: true
editor: source
---

```{r}
#| echo: false
#| output: false
#| warning: false

# loading needed libraries
library(here)
library(tidyverse)
library(GGally)
library(grid)
library(randomForest)
library(corrplot)
library(readxl)
library(cowplot)
library(rnaturalearth)
library(rnaturalearthdata)
library(plotly)
library(RColorBrewer)
library(sf)
library(gridExtra)
```

```{r}
#| echo: false
#| warning: false
# loading the needed data
whr <- read.csv(here::here("Data/WHR_AllYears.csv"))

# fix data type of perception of corruption
whr$perceptions_of_corruption <- as.numeric(whr$perceptions_of_corruption)

# fix the naming of "Somaliland region" to "Somaliland Region" for consistency
whr[whr$country == "Somaliland region",]$country = "Somaliland Region"

# add Somalian Region to Sub-Saharan Africa
whr[whr$country == "Somaliland Region",]$region = "Sub-Saharan Africa"

whr_exp <- read_excel(here::here("Data/2024_Yearly_Expectations.xls"))

whr_exp <- whr_exp %>% rename(country = "Country name")

# match explaining data with whr data
matched_data <- whr_exp %>%
  inner_join(whr, by = c("year", "country"))

# only keep unscaled data
matched_data <- matched_data[,1:11]

colnames(matched_data) <- c("country", "year", "life_ladder", "log_gdp_per_capita",
                            "social_support","healthy_life_expectancy_at_birth",
                            "freedom_to_make_life_choices", "generosity",
                            "perceptions_of_corruption", "positive_affect",
                            "negative affect")
```

# Introduction and Background

## About the World Happiness Report

The World Happiness Report (WHR) is a reflection of the worldwide evaluation of happiness and well-being across 170 countries (World Happiness Report). WHR measures the happiness state on a yearly basis and emphasizes the need for incorporating well-being factors in government policy making.

The report is a collaboration of Gallup, the Oxford Wellbeing Research Centre, the United Nation's Sustainable Development Solutions Network and the WHR's Editorial Board. The first report was released in the year 2012.

### Understanding the Happiness Score

Happiness scores are measured based on the survey responses from the Gallup World Poll (GWP) (World Happiness Report). The evaluation from the GWP primarily stems from answers of the survey questions and the Cantril Ladder score. The poll comprises more than 100 questions that include global questions and region-specific topics regarding several well-being areas. Those well-being areas include law and order, good jobs, well-being, food and shelter, institutions and infrastructure, and brain gain (Wikipedia 2024). Gallup typically collects for a sample size of 1,000 people for each country annually.

Next, the Cantril Ladder score is a score range of 0 to 10, where 0 being the worst well-being condition and 10 being the best well-being condition. The Cantril Ladder asks to rate the current state of the respondents' well-being on this scale. The researchers of the WHR take the average score of the last 3 years and use it as the happiness score for the current year in order to even out fluctuations based on regional events like changes in government (4. World Happiness Report 2024). This average ladder score is the overall national **happiness score**. Sometimes, the term "*life evaluation*" is used interchangeably with happiness score.

## Explanatory Variables

In @fig-whr, which is Figure 2.1 of the World Happiness Report 2024, the happiness score or life evaluation is indicated for each country in the entire dataset.

![WHR Figure 2.1: Country Rankings by Life Evaluations in 2021-2023](WHR_CountryRankings_Explained.png){#fig-whr fig-env="figure*"}

Six explanatory variables are derived from the poll answers, and the associations of these variables with the happiness score help explain the variations across different countries. Those variables are Gross Domestic Product (GDP) per capita, healthy life expectancy, social support, freedom to make life choices, perceptions of corruption and generosity. Another variable shown in the plot is called "Dystopia + residual". Definitions of these variables will be explained in the Data section (@sec-data) of this report.

According to the report, the sub-bars in @fig-whr, which represent the explanatory variables, do not influence the total score reported for each country (World Happiness Report 2024), however they merely indicate the country's overall score explained by each of the six explanatory variables (World Happiness Report). The sub-bars are measured by multiplying average data for the period of the last 3 years for each of those variables. For the 2024 report, the national average for 2021-2023 are calculated for the display of the sub-bars for each variable.

## Goal of this research

The goal of this report is to take a collaborative approach to explore and visualize different perspectives on the data to find connections between the happiness score and its explanatory variables and exploring how the happiness score behaves over different countries and regions. <br>
First, the variables are explored in their distributions to gain a base understanding about them. To understand which countries are represented by the data and how the happiness score distributes over different countries, a world map with countries colored by the extent of their average happiness score is discussed. <br>
Since happiness score might be influenced by the other variables, there also are plots to represent the relationship between the happiness score and each of its explanatory variables. <br>
To add to a further understanding about the connection between the explanatory variables and the geographical location, the countries are ranked by their average performance over each explanatory variable and the ten best and worst countries are presented. Finally, the ranking is done for the happiness score and connections are discussed. <br>
In order to take advantage of the explanatory nature of the variables towards the happiness score, two different Machine Learning models are used to explore patterns and feature importance ranking of the predictor variables. For this, first a Kmeans Clustering algorithm is used on all numeric variables including the happiness score, to see how it splits the data and how this grouping can be interpreted. To find out more about feature importance when predicting the happiness score, a Random Forest is used to calculate feature importance from two different perspectives - decreasing prediction errors and improving how well the data is split into groups.

# Software and Tools

For the analysis, RStudio Desktop environment was used. The following packages were used for data manipulation, visualization, and analysis.

-   `here`

-   `tidyverse`

-   `GGally`

-   `grid`

-   `randomForest`

-   `corrplot`

-   `readxl`

-   `cowplot`

-   `rnaturalearth`

-   `plotly`

Functions from these packages were used to conduct the analysis, with the following functions being particularly important:

-   `randomForest`

    `randomForest` implements Breiman's random forest algorithm for classification and regression. Random subsets of data are used when training a random forest model. From the model evaluation, important features can be determined.

# Data {#sec-data}

## World Happiness Report Data 2015-2023

The dataset was obtained from the Kaggle datasets collection. It includes the World Happiness Report data between 2015 and 2023. The dataset contains the country name, region name, national happiness score, and the other explanatory factors (Islam 2023). Those explanatory factors are GDP per capita, social support, healthy life expectancy, freedom to make life choices, generosity, and perceptions of corruption. The variables in the dataset represent socio-economic and well-being statuses from the individuals who participated in the Gallup World Poll in that duration. It is the dataset which is mainly used in this report.

One small change was made to the dataset in the context of data cleaning. There was a region named "Africa" that is explained by the Somaliland Region being assigned to Africa when first appearing in the world happiness report. This region functions like an own country but officially belongs to Somalia which poses a corner case for assigning country and region for this country. That is why we decided to change the region for this country to Sub-Saharan Africa, which is the region Somalia belongs to.

## World Happiness Report 2024 Chapter 2 Appendix {#sec-GWP-data}

The dataset for the Chapter Appendix comes from the survey responses of the Gallup World Poll from 2005 and 2023. The dataset contains demographic information, namely country name and region name, and numerical information for GDP per capita, social support, healthy life expectancy, freedom to make life choices, generosity and perceptions of corruption. Contrary to the previous dataset, the GDP per capita and healthy life expectancy columns is in its true average representation and not adjusted for the life evaluation score. That is why this dataset is used for visualizing some of the variable distributions in @sec-distro.

## Variable Definitions

**Happiness score** is a measure of subjective well-being (SWB) in the Gallup World Poll (GWP) covering years from 2005/06 to 2023. Unless stated otherwise, it is the national average response to the question of life evaluations and for the WHR it is averaged over 3 years to determine the value for the next year. The question in the poll that directly measures the score is “Please imagine a ladder, with steps numbered from 0 at the bottom to 10 at the top. The top of the ladder represents the best possible life for you and the bottom of the ladder represents the worst possible life for you. On which step of the ladder would you say you personally feel you stand at this time?”

This measure is also referred to as Cantril life ladder.

**GDP per capita** (GDP stands for gross domestic product) is the purchasing power parity at 2017 constant international dollar prices from World Development Indicators. When the latest GDP per capita is not available as of a certain date of the year, country-specific forecasts of real GDP growth from the Economic Outlook is used for average calculation. If it is unavailable from the Economic Outlook, then forecasts from the World Bank's Global Economic Prospects are utilized.

**Healthy Life Expectancy** (LSE) at birth are based on the Global Health Observatory data by the World Health Organization (WHO).

**Social support** represents the national average of the ability to rely on someone in times of trouble and the representation is in binary responses (either 0 or 1). In the GWP, the binary response is collected from the question "If you were in trouble, do you have relatives or friends you can count on to help you whenever you need them, or not?".

**Freedom** represents the ability to make life decisions from the GWP question "Are you satisfied or dissatisfied with your freedom to choose what you do with your life?".

**Generosity** is the national average of answers to the GWP question "Have you donated money to a charity in the past month?".

**Corruption** is the perceptive measure from the following 2 questions in the GWP. Those questions are "Is corruption widespread throughout the government or not?" and "Is corruption widespread within businesses or not?". 
<br>
<br> The following variables are not included in the used dataset but are explained in the context of completeness: <br> 
<br>
**Positive affect** is defined as the average of three positive affect measures in the GWP: laugh, enjoyment and doing interesting things in the GWP.

These measures are the responses to the following three questions, respectively:

-   “Did you smile or laugh a lot yesterday?”

-   “Did you experience the following feelings during A LOT OF THE DAY yesterday? How about Enjoyment?”

-   “Did you learn or do something interesting yesterday?”

**Negative affect** is defined as the average of three negative affect measures in the GWP. They are worry, sadness and anger.

Those emotional states are respective responses to the following questions:

-   “Did you experience the following feelings during A LOT OF THE DAY yesterday? How about Worry?”

-   “Did you experience the following feelings during A LOT OF THE DAY yesterday? How about Sadness?”

-   “Did you experience the following feelings during A LOT OF THE DAY yesterday? How about Anger?”

**Dystopia** is an imaginary country that has the world’s least-happy people. The purpose in establishing Dystopia is to have a benchmark against which all countries can be favorably compared (no country performs more poorly than Dystopia) in terms of each of the six key variables, thus allowing each sub-bar to be of positive (or zero, in six instances) width. The lowest scores observed for the six key variables, therefore, characterize Dystopia.

# Variable Distributions {#sec-distro}
## Distributions of happiness score and the explanatory variables

```{r}
#| warning: false
#| echo: false
#| label: fig-distributions
#| fig-cap: "Distribution graphs of the numerical variables. For all of the plots except a, b and i, the original data from the Gallup World Poll is used in order to see the true distributions and not the scaled ones that were calculated for the World Happiness Report. The red dashed lines in the density plots show the corresponding mean values." 
#| fig-scap: "Distribution graphs of variables."
#| fig-subcap:
#|   - "Distribution of Happiness Score"
#|   - "Distribution of Region"
#|   - "Distribution of log GDP per Capita"
#|   - "Distribution of Social Support"
#|   - "Distribution of Healthy Life Expectancy"
#|   - "Distribution of Generosity"
#|   - "Distribution of Freedom to make Life Choices"
#|   - "Distribution of Perceptions of Corruption"
#|   - "Distribution of Countries per Year"
#| layout-ncol: 2

# Calculate the mean values
mean_happiness <- mean(whr$happiness_score, na.rm = TRUE)
quantiles_happiness <- quantile(whr$happiness_score, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
mean_log_gdp_per_capita <- mean(matched_data$log_gdp_per_capita, na.rm = TRUE)
mean_social_support <- mean(matched_data$social_support, na.rm = TRUE)
mean_healthy_life_expectancy_at_birth <- mean(matched_data$healthy_life_expectancy_at_birth, na.rm = TRUE)
mean_generosity <- mean(matched_data$generosity, na.rm = TRUE)
mean_freedom_to_make_life_choices <- mean(matched_data$freedom_to_make_life_choices, na.rm = TRUE)
mean_perceptions_of_corruption <- mean(matched_data$perceptions_of_corruption, na.rm = TRUE)

ggplot(whr, aes(x = happiness_score)) +
  geom_freqpoly(bins = 10) +
  xlab("Happiness Score") +
  geom_vline(aes(xintercept = mean_happiness), color = "red", linetype = "dashed", size = 1) + 
  annotate("text", x = mean_happiness, y = 0, label = round(mean_happiness, 2), color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(whr, aes(x = region, fill = region)) +
  geom_bar() +
  xlab("Region") +
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  guides(fill="none")

ggplot(matched_data, aes(x = log_gdp_per_capita)) +
  geom_freqpoly(bins = 10) +
  xlab("Log GDP per Capita") +
  geom_vline(aes(xintercept = mean_log_gdp_per_capita), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_log_gdp_per_capita, y = 0, label = round(mean_log_gdp_per_capita, 2), color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(matched_data, aes(x = social_support)) +
  geom_freqpoly(bins = 10) +
  xlab("Social Support") +
  geom_vline(aes(xintercept = mean_social_support), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_social_support, y = 0, label = round(mean_social_support, 2), color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(matched_data, aes(x = healthy_life_expectancy_at_birth)) +
  geom_freqpoly(bins = 10) +
  xlab("Healthy Life Expectancy") +
  geom_vline(aes(xintercept = mean_healthy_life_expectancy_at_birth), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_healthy_life_expectancy_at_birth, y = 0, label = round(mean_healthy_life_expectancy_at_birth, 2), color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(matched_data, aes(x = generosity)) +
  geom_freqpoly(bins = 10) +
  xlab("Generosity") +
  geom_vline(aes(xintercept = mean_generosity), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_generosity, y = 0, label = round(mean_generosity, 2), color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(matched_data, aes(x = freedom_to_make_life_choices)) +
  geom_freqpoly(bins = 10) +
  xlab("Freedom to make Life Choices") +
  geom_vline(aes(xintercept = mean_freedom_to_make_life_choices), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_freedom_to_make_life_choices, y = 0, label = round(mean_freedom_to_make_life_choices, 2),
           color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(matched_data, aes(x = perceptions_of_corruption)) +
  geom_freqpoly(bins = 10) +
  xlab("Perceptions of Corruption") +
  geom_vline(aes(xintercept = mean_perceptions_of_corruption), color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = mean_perceptions_of_corruption, y = 0, label = round(mean_perceptions_of_corruption, 2), 
           color = "red", vjust = -1, hjust = -0.1, size = 5) +
  ylab("Count") +
  theme(text = element_text(size = 15))

ggplot(whr, aes(x = year, fill = as.factor(year))) +
  geom_bar() +
  xlab("Year") +
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  guides(fill="none")
```

@fig-distributions shows the distributions of numerical variables. For all of the plots except a, b and i, the original data from the Gallup World Poll (see @sec-GWP-data) is used in order to see the true distributions and not the scaled ones that were calculated for the World Happiness Report.

Most of the distributions are skewed towards one side. GDP per capita, social support, healthy life expectancy and perceptions of corruption are left-skewed: The tip of the density curve is located on the right side of the plot, but there is a long tail for lower values. Generosity's distribution on the other hand appears to be right-skewed as there are more values for high values than for very low values. The tip of the curve is close to 0 on the negative side though, which leads to a mean value of zero. The happiness score appears to be somewhat normally distributed with 5.44 being the mean value of the answer scale 0 - 10.<br> For region, the African and European regions make up most of the data set.<br> The distribution of countries that participated per year shows that from 2019 onward there has been a notable decline in countries that took part in the world happiness report.

## Distribution of the Happiness Score around the globe {#sec-distro-globe}
```{r}
#| echo: false
#| warning: false
#| label: fig-world-map
#| fig-cap: "Heatmap of the Happiness Score around the globe based on the latest available data. Grey areas indicate countries where data is not available." 
#| fig-scap: "Heatmap of the Happiness Score around the globe based on the latest available data. Grey areas indicate countries where data is not available." 

# Filter data for the latest year
latest_year <- max(whr$year)
latest_data <- whr %>% filter(year == latest_year)

# Get the world map data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Correct country names in the data to match those in the world map data
latest_data$country <- recode(latest_data$country,
                              "United States" = "United States of America",
                              "Taiwan Province of China" = "Taiwan",
                              "Bosnia and Herzegovina" = "Bosnia and Herz.",
                              "Dominican Republic" = "Dominican Rep.",
                              "Hong Kong S.A.R. of China" = "Hong Kong",
                              "Congo (Brazzaville)" = "Congo",
                              "Ivory Coast" = "Côte d'Ivoire",
                              "State of Palestine" = "Palestine",
                              "Turkiye" = "Turkey",
                              "Congo (Kinshasa)" = "Dem. Rep. Congo")

# Merge the happiness data with the world map data
world_data <- world %>%
  left_join(latest_data, by = c("name" = "country"))

# Calculate centroids for the countries
world_data_centroids <- st_centroid(world_data)

# Create the heatmap with ggplot
p <- ggplot() +
  geom_sf(data = world_data, aes(fill = happiness_score, text = paste("Country:", name, "<br>Happiness Score:", happiness_score))) +
  geom_sf(data = world_data_centroids, aes(geometry = geometry, text = paste("Country:", name, "<br>Happiness Score:", happiness_score)), color = NA, size = 0) +
  scale_fill_viridis_c(na.value = "grey50") +
  labs(title = "World Happiness Map",
       fill = "Happiness Score") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank())

# Convert ggplot to plotly for interactivity
plotly_map <- ggplotly(p, tooltip = "text")

# Adjust the size of the plot
plotly_map <- plotly_map %>% layout(width = 850)

plotly_map
```

@fig-world-map is a heatmap visualizing the happiness score around the globe based on the latest available data. The distribution of happiness scores worldwide shows clear regional patterns. Happiness scores tend to be higher in North America, Western Europe and Oceania, as indicated by the lighter colors in these regions. Countries such as Finland, which is known as the happiest country in the world with a happiness score of 7.8, are located in this region and have the highest happiness scores. This is particularly visible in Scandinavia and other parts of Northern Europe.

In severe contrast are regions such as Sub-Saharan Africa and South Asia, where happiness scores are significantly lower, as indicated by the darker colors on the map. Afghanistan is the country with the lowest happiness score with a score of 1.9 and is located in South Asia, which can also be seen on the map by the darker colors.

Other interesting patterns can be observed in Latin America and Eastern Europe, where the happiness scores are medium to high. In these regions, the scores are more variable, indicating a mix of countries with different socio-economic conditions.

Overall, the map shows that the highest happiness scores are mainly found in wealthy and developed countries, while the lowest scores occur in regions with economic and social challenges. This global distribution of happiness scores illustrates the strong regional differences in perceived well-being and suggests the significance of socio-economic factors for individual happiness.

# Relationship between Happiness Score and its numerical explanatory variables {#sec-rel-pred}

In this section the influence of the explanatory variables and the regions on the happiness score is explored. The box plots of happiness score over different regions highlights the differences over the globe which are already recognizable in sec-distro-globe. In order to find out what makes humans most happy, the correlations between the variables and the happiness score can give some indication. This is emphasized by scatter plots which also show the different regions' influences on these correlations.

## Influence of region on the happiness score
```{r}
#| echo: false
#| label: fig-box-regions
#| fig-cap: "Boxplot Happiness Score based on different regions." 
#| fig-scap: "Boxplot Happiness Score based on different regions."
#| layout-ncol: 1
whr |>
  ggplot(aes(x = region, y = happiness_score, fill = region)) +
  geom_boxplot() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        text = element_text(size = 14)) +
  ylab("Happiness Score") +
  coord_flip()
```

When looking at how the happiness score is connected to the regions of the countries we have data for, we can see that they differ a lot in their spread. This is shown in @fig-box-regions. Western Europe and North America and ANZ have the comparatively highest median happiness scores. In contrast, for Sub-Saharan Africa and South Asia the median happiness is the lowest. The regions also differ strongly in the variance. The interquartile range (the range of variables within the first and third quarter percentiles) is larger in the Middle East and North Africa while for North America and ANZ the box is very small. The latter can be explained by only few countries stretching over big continents, thus leaving fewer happiness score results for this big region and all of its inhabitants. <br> Regions is understood as an aggregation for the variable country, as there are a big number of countries covered that it is not possible to visualize it. We are looking into countries that show interesting patterns later in the report.

## Influence of the explanatory variables

```{r}
#| echo: false
#| output: false
#| label: fig-multiple-scatter
#| fig-cap: "Scatterplots for relationship of happiness score and different predictor variables. The colors of the dots represent the corresponding region." 
#| fig-scap: "Scatterplots for relationship of happiness score and different predictor variables."
#| fig-subcap:
#|   - "Happiness Score over GDP per Capita"
#|   - "Happiness Score over Social Support"
#|   - "Happiness Score over Healthy Life Expectancy"
#|   - "Happiness Score over Freedom to make Life Choices"
#|   - "Happiness Score over Generosity"
#|   - "Happiness Score over Perceptions of Corruption"
#|   - "Legend"
#| layout-ncol: 2

# GDP per capita plot
whr |>
  ggplot(aes(x = gdp_per_capita, y = happiness_score, color = region)) +
  geom_point() +
  xlab("GDP per Capita") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Social Support Plot
whr |>
  ggplot(aes(x = social_support, y = happiness_score, color = region)) +
  geom_point() +
  xlab("Social Support") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Healthy Life Expectancy plot
whr |>
  ggplot(aes(x = healthy_life_expectancy, y = happiness_score, color = region)) +
  geom_point() +
  xlab("Healthy Life Expectancy") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Freedom to make life choices
whr |>
  ggplot(aes(x = freedom_to_make_life_choices, y = happiness_score, color = region)) +
  geom_point() +
  xlab("Freedom to make Life Choices") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Generosity
whr |>
  ggplot(aes(x = generosity, y = happiness_score, color = region)) +
  geom_point() +
  xlab("Generosity") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Perceptions of corruption
whr |>
  ggplot(aes(x = perceptions_of_corruption, y = happiness_score, color = region)) +
  geom_point() +
  xlab("Perceptions of corruption") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 15), legend.position = "none")

# Get the legend
scatter_plot <- whr |>
  ggplot(aes(x = gdp_per_capita, y = happiness_score, color = region)) +
  geom_point() +
  xlab("GDP per Capita") +
  ylab("Happiness Score") +
  theme(text = element_text(size = 25), legend.position = "right")+
  guides(color = guide_legend(override.aes = list(size = 5)))

# Extract the legend
legend = get_plot_component(scatter_plot, 'guide-box-right', return_all = TRUE)
ggdraw(legend)

```

```{r}
#| echo: false
#| label: fig-corr-mat
#| fig-cap: "Correlation matrix plot. HS = Happiness Score, GpC = GDP per Capita, SS = Social Support, HLE = Healthy Life Expectancy, FtmLC = Freedom to make life choices, G = Generosity, PoC = Perception of Corruption, Y = Year."
#| fig-scap: "Correlation matrix plot. HS = Happiness Score, GpC = GDP per Capita, SS = Social Support, HLE = Healthy Life Expectancy, FtmLC = Freedom to make life choices, G = Generosity, PoC = Perception of Corruption, Y = Year."
#| layout-ncol: 1

#remove non-numeric variables
whr_num <- whr[, c(3,4,5,6,7,8,9,10)]
whr_num$year <- as.numeric(whr_num$year)

# remove NaN values
whr_num_nonan <- na.omit(whr_num)

# calculate correlation
whr_cor <- cor(whr_num_nonan)

# shorten the variable names for the plot
new_names <- c("HS", "GpC", "SS", "HLE", "FtmLC", "G", "PoC", "Y")
colnames(whr_cor) <- new_names
rownames(whr_cor) <- new_names

# calculate p-values
testRes <- cor.mtest(whr_num_nonan, conf.level = 0.95)
colnames(testRes$p) <- new_names
rownames(testRes$p) <- new_names

corrplot(whr_cor, p.mat = testRes$p, method = 'circle', type = 'lower', insig='blank',
         addCoef.col ='black', number.cex = 0.8, order = 'AOE', diag=FALSE)
```

@fig-multiple-scatter shows the relationship of the happiness score and the explanatory variables and the colors of the dots represent which region the corresponding country belongs to. Subplot a shows the relationship between GDP per capita and the happiness score. There seems to be a positive linear relationship between the variables, as with higher GDP the happiness score rises. The relationship is stronger than it seems from the plot, as the scale ratio of x- and y-axis are so different. The correlation of these variables, which can be seen in figure @fig-corr-mat, is very high with a value of 0.72. It helps to provide further proof for the linear relationship between the variables. From the colors of the dots we can see that Sub-Saharan Africa and South Asia have both low GDP per capita and low happiness score values while Western Europe has the highest happiness score and also some of the highest GDP per capita values, followed by North America and ANZ.

Similar plots results from the relationships of Social Support (subplot b), Healthy Life Expectancy (subplot c) and Freedom to make Life Choices (subplot d) with the happiness score. There is a positive linear relationship between both variables and the correlations are not as strong as for GDP per capita but still very strong with a values of 0.68 for Healthy Life Expectancy, followed by 0.65 for Social Support and 0.57 for Freedom to make Life Choices. Also, the regional influences are similar for these plots. Interestingly, for healthy life expectancy some values are missing.

For generosity (subplot e) there is no connection between the variables visible. It is notable that there are three outlier countries with high generosity values from Southeast Asia, which have a below average happiness score.

The plot of perceptions of corruption (subplot f) shows a slight upward trend in happiness score for higher perceptions of corruption, but it is only a fraction of data points that score high on perceptions of corruption. Also, there is missing data for this variable. The correlation plot shows that there is again a positive correlation between the two variables of 0.41, even if it is weak compared to other variables that have been looked at.

## Influence of the Year

```{r}
#| echo: false
#| label: fig-box-year
#| fig-cap: "Boxplot Happiness Score over Years." 
#| fig-scap: "Boxplot Happiness Score over Years."
#| layout-ncol: 1
whr$year <- as.factor(whr$year)
whr |>
  ggplot(aes(x = year, y = happiness_score, fill = year)) +
  geom_boxplot() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        text = element_text(size = 15))+
  ylab("Happiness Score")
```

As observable in @fig-box-year, for medians, there is a slight upwards trend over the years, with 2020 to 2022 having less variance compared to the other years. Furthermore, there are negative outliers for 2021 to 2023.

```{r}
#| echo: false
#| label: fig-highest-change
#| fig-cap: "Top-3 Countries with highest positive and negative change in happiness score from 2015 to 2023."
#| fig-scap: "Top-3 Countries with highest positive and negative change in happiness score from 2015 to 2023."
#| layout-ncol: 1

# Calculate the change in happiness score for each country
change_data <- whr %>%
  mutate(year = as.numeric(as.character(year))) %>%
  group_by(country) %>%
  summarize(
    first_year = min(year),
    last_year = max(year),
    first_score = happiness_score[year == first_year],
    last_score = happiness_score[year == last_year],
    change = last_score - first_score
  )

# Identify the top 3 countries with the most improvement
most_improved <- change_data %>% arrange(desc(change)) %>% head(3)

# Identify the top 3 countries with the most decline
most_declined <- change_data %>% arrange(change) %>% head(3)

# Combine these countries into one data frame
top_countries <- bind_rows(most_improved, most_declined)

# Create a bar chart for the changes in happiness score
ggplot(top_countries, aes(x = reorder(country, change), y = change, fill = change > 0)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Countries with Highest Change in Happiness Score from 2015 to 2023",
       x = "Country",
       y = "Change in Happiness Score",
       fill = "Improved") +
  scale_fill_manual(values = c("TRUE" = "darkgreen", "FALSE" = "darkred")) +
  theme_minimal() +
  theme(legend.position = "none")
```

The chart in @fig-highest-change shows the countries with the largest changes in the happiness score from 2015 to 2023. The countries are sorted by their difference in their happiness scores, with positive changes shown in green and negative changes in red.
Romania, Guinea, and Ivory Coast are the countries with the greatest improvements in happiness score, with Romania showing the highest positive change. On the other hand, Venezuela, Afghanistan, and Lebanon have experienced the largest decreases in happiness scores, with Lebanon showing the largest decrease. These differences illustrate that global wellbeing indicators develop in manifold ways across the globe.

```{r, fig.width=15}
#| echo: false
#| label: fig-highest-change-each-year
#| fig-cap: "Development of happiness score over the years for countries with greatest positive and negative change."
#| fig-scap: "Development of happiness score over the years for countries with greatest positive and negative change."
#| layout-ncol: 1

# Filter the data for the six countries
filtered_data <- whr %>% filter(country %in% top_countries$country)

# Create a new column to distinguish improving and declining countries
filtered_data <- filtered_data %>%
  mutate(trend = ifelse(country %in% most_improved$country, "Improving", "Declining"))

# Create line charts for the happiness scores over the years
p1 <- ggplot(filtered_data %>% filter(trend == "Improving"),
             aes(x = year, y = happiness_score, color = country, group = country)) +
  geom_line() +
  geom_point() +
  labs(title = "Happiness Score Over the Years (Improving Countries)",
       x = "Year",
       y = "Happiness Score") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 17, face = "bold"),
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_text(size = 17),
    legend.text = element_text(size = 15)
  )

p2 <- ggplot(filtered_data %>% filter(trend == "Declining"),
             aes(x = year, y = happiness_score, color = country, group = country)) +
  geom_line() +
  geom_point() +
  labs(title = "Happiness Score Over the Years (Declining Countries)",
       x = "Year",
       y = "Happiness Score") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 17, face = "bold"),
    axis.title = element_text(size = 17),
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_text(size = 17),
    legend.text = element_text(size = 15)
  )

# Arrange the two plots side by side
grid.arrange(p1, p2, ncol = 2)
```

The two graphs in @fig-highest-change-each-year show the development of happiness scores over the years for the countries that have experienced the greatest changes. The left-hand diagram shows that Romania has seen a steady increase in happiness score, especially in recent years. The development in happiness score for the Ivory Coast and Guinea is not as steady as for Romania, but the overall trend is positive. Both countries improved their happiness score from about 3.7 in 2015 to about 5 in 2023.

The diagram on the right shows a clear continuous downward trend for both Lebanon and Afghanistan. Venezuela's happiness score is declining until 2019 and plateauing since then.

# Top and Bottom 10 Ranking of Countries

## Ranking for each Predictor Variable
```{r}
#| warning: false
#| echo: false
countries_df <- whr |>
  group_by(country) |>
  summarize_if(is.numeric, mean)

save_region <- whr[,1:2] |>
  arrange(country) |>
  distinct(country, .keep_all = TRUE)
  
countries_df$region <- save_region$region  
```


```{r}
#| warning: false
#| echo: false
#| label: fig-ranking1
#| fig-cap: "Top and bottom ranking of countries over predictors colored by region." 
#| fig-scap: "Top and bottom ranking of countries over predictors colored by region."
#| fig-subcap:
#|   - "Top 10 countries: GDP per Capita"
#|   - "Bottom 10 countries: GDP per Capita"
#|   - "Top 10 countries: Social Support"
#|   - "Bottom 10 countries: Social Support"
#|   - "Top 10 countries: Healthy Life Expectancy"
#|   - "Bottom 10 countries: Healthy Life Expectancy"
#|   - "Top 10 countries: Generosity"
#|   - "Bottom 10 countries: Generosity"
#|   - "Top 10 countries: Freedom to make Life Choices"
#|   - "Bottom 10 countries: Freedom to make Life Choices"
#|   - "Top 10 countries: Perceptions of Corruption"
#|   - "Bottom 10 countries: Perceptions of Corruption"
#| layout-ncol: 2

# set a fixed colour scale over 11 regions
my_colors <- setNames(c("#FFCC33", "#00FF66", "#CCFF33", "#66FFFF", "#CC99FF", "#FFCCFF", "#FF9966", "#00CCFF", "#FF6600", "#FF66FF"), levels(as.factor(countries_df$region)))
# light orange, neon green, light green, light blue, light violet,
# light pink, light red, sky blue, red orange, pink

# GDP per capita
countries_df |>
  arrange(desc(gdp_per_capita)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, gdp_per_capita), y = gdp_per_capita, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("GDP per Capita") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(gdp_per_capita) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, gdp_per_capita), y = gdp_per_capita, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("GDP per Capita") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

# Social Support
countries_df |>
  arrange(desc(social_support)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, social_support), y = social_support, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Social Support") +
  ylab("Countries") + 
  theme(text = element_text(size = 13))

countries_df |>
  arrange(social_support) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, social_support), y = social_support, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Social Support") +
  ylab("Countries") + 
  theme(text = element_text(size = 13))

# Healthy Life Expectancy
countries_df |>
  arrange(desc(healthy_life_expectancy)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, healthy_life_expectancy), y = healthy_life_expectancy, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Healthy Life Expectancy") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(healthy_life_expectancy) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, healthy_life_expectancy), y = healthy_life_expectancy, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Healthy Life Expectancy") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

# Generosity
countries_df |>
  arrange(desc(generosity)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, generosity), y = generosity, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Generosity") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(generosity) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, generosity), y = generosity, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Generosity") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

# Freedom to make Life Choices
countries_df |>
  arrange(desc(freedom_to_make_life_choices)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, freedom_to_make_life_choices), y = freedom_to_make_life_choices, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Freedom to make Life Choices") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(freedom_to_make_life_choices) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, freedom_to_make_life_choices), y = freedom_to_make_life_choices, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Freedom to make Life Choices") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

# Perceptions of Corruption
countries_df |>
  arrange(desc(perceptions_of_corruption)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, perceptions_of_corruption), y = perceptions_of_corruption, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Perceptions of Corruption") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(perceptions_of_corruption) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, perceptions_of_corruption), y = perceptions_of_corruption, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("Perceptions of Corruption") +
  ylab("Countries") +
  theme(text = element_text(size = 13))
```
When looking at the resulting top and bottom rankings and the regions that these countries belong to in @fig-ranking1, there is a clear pattern showing high ranking countries often are from Western Europe and Low-Ranking countries are from African regions for most plots. However, for generosity there is an exception with the highest ranking countries being from a variety of regions not fitting the pattern for other predictors consisting of a lot of Western European Countries. Also for bottom ranking countries for generosity, there are some Central and Eastern European countries ranked lowest. For perceptions of corruption, where a bottom rank has a positive connotation and best ranking a negative one, it shows a strong inner-European rift where there are a lot of Western European countries scoring high but Central and Eastern European country scoring lowest.

## Ranking for Happiness Score
```{r}
#| warning: false
#| echo: false
#| label: fig-ranking2
#| fig-cap: "Top and bottom ranking of countries for happiness score colored by region." 
#| fig-scap: "Top and bottom ranking of countries for happiness score colored by region."
#| fig-subcap:
#|   - "Top 10 countries: Happiness Score"
#|   - "Bottom 10 countries: Happiness Score"
#| layout-ncol: 2

countries_df |>
  arrange(desc(happiness_score)) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, happiness_score), y = happiness_score, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("GDP per Capita") +
  ylab("Countries") +
  theme(text = element_text(size = 13))

countries_df |>
  arrange(happiness_score) |>
  slice_head(n = 10) |>
  ggplot() +
  geom_col(aes(x = reorder(country, happiness_score), y = happiness_score, fill = region)) +
  coord_flip() +
  scale_fill_manual(values = my_colors) +
  xlab("GDP per Capita") +
  ylab("Countries") +
  theme(text = element_text(size = 13))
```
When ranking the happiness score (@fig-ranking2), the pattern for top countries continues with the top countries all being Western European, followed by North American and ANZ countries. For the lowest ranking countries, all except Afghanistan are from Africa, following part of the pattern seen in predictors. African countries ranking lowest for GDP per capita, social support, healthy life expectancy and freedom to make life choices which seem to influence happiness strongly. On the other hand, countries from regions that rank highly for predictors also appear here, showing that stable and comfortable living conditions coincide with high happiness. Happier regions also rank higher for perceived corruption.

# Using K-means Clustering to find interesting patterns

It is the goal to use K-means clustering to provide a pattern that is interpretable and give further context to the relationship between the happiness score and other variables. The procedure will first be introduced, then the data is scaled for an optimal performance and the best amount of clusters will be chosen by using the elbow-criteria to sensibly minimize total within sum-of-squares. In other words, the goal is to minimize the overall distance between points in each cluster. At the end, a final model is trained and the result is plotted. <br> It is important to mention that K-Means can only be used for continuous variables, so country, region, and year are not considered here.

## Introduction K-Means

K-Means Clustering is an unsupervised machine learning method that can help classify data that has no label that a model could be trained on. This is made possible by a distance-based approach that fits the clusters so that the distances between the data points within a cluster are minimal. The distance in this case is a measure of similarity between data points, so in other words we want to fit clusters so that the points contained in one cluster are as similar as possible.

## Using PCA for K-Means performance optimization

```{r}
#| echo: false
# create a subset that doesn't contain country, region and year
whr_sub <- whr[,-c(1,2,10)]

# delete rows that contain NAs from the data frame
whr_sub <- na.omit(whr_sub)
```

A good measure for improving the performance of K-Means is doing PCA on the data as it can aggregate the information. However, PCA is only useful if you can cover around 80% of the total variance of the data with only few principle components.

```{r}
#| echo: false
pr.out <- prcomp(whr_sub, scale = TRUE)

# get percent of variance of each principal component
perc <- pr.out$sdev/sum(pr.out$sdev)
```

```{r}
#| echo: false
#| label: fig-pca-cum
#| fig-cap: "Cumulative Proportion of the Variance explained by each Principle Component."
#| fig-scap: "Cumulative Proportion of the Variance explained by each Principle Component."
#| layout-ncol: 1
# plot cumulative sum of the percentages
plot(cumsum(perc),
  xlab = "Principal Component",
  ylab = "Proportion of Variance Explained",
  ylim = c(0,1),
  type = "b")
```

As can be seen in @fig-pca-cum, it would be necessary to use four to five of seven variables to cover a sufficient amount of variance. Since this is not too helpful and each principle component contains a similar amount of variance, PCA is not applied.

## Finding a good amount of clusters

In general, the higher the number of clusters, the more similar the points will be within one cluster. However, the model also gets harder to interpret and messy. Therefore, using the elbow-criterion, the hyperparameter k that equals the number of clusters should be sensibly minimized so that we get an interpretable result. <br> To find k, the total within sum of squares for two to ten clusters is calculated and plotted.

```{r}
#| echo: false
# scale data
sc_whr <- scale(whr_sub)

# initiate vector to store total within sum of squares for each kmeans()-object
wss <- c()

# run kmeans for k equals two to seven and save total within sum of squares
for (k in 2:7) {
  km.out <- kmeans(sc_whr, centers = k, nstart = 20)
  wss <- append(wss, km.out$tot.withinss)
}
```

```{r}
#| echo: false
#| label: fig-wss-plot
#| fig-cap: "Optimal k-value for Kmeans algorithm when applying the elbow-criterion to the within sum of squares plot with marked cut-off value of k = 2." 
#| fig-scap: "Optimal k-value for Kmeans algorithm when applying the elbow-criterion to the within sum of squares plot with marked cut-off value of k = 2."
#| layout-ncol: 1
# plot the resulting values
plot(wss, xlab = "k", ylab = "WSS", type = "b", main = "Within sum of squares over different amounts of clusters")
abline(v = 2, col = "red", lty = 2)
```

When plotting within sum of squares and applying the elbow criteria (@fig-wss-plot) fter k = 2 the decrease of within sum of squares is not as strong anymore. Therefore, the K-Means model is trained with two clusters.

## Kmeans Clustering Result

```{r}
#| echo: false
# train K-Means
set.seed(1)
km.out <- kmeans(sc_whr, centers = 2, nstart = 20)

my.text.panel <- function(labels) {
  function(x, y, lbl, ...) {
    if (lbl %in% names(labels)) lbl <- labels[[lbl]]
    text(x, y, lbl, ...)
  }
}
```

```{r fig.width=10, fig.height=10}
#| echo: false
#| label: fig-k-means-plot
#| fig-cap: "Matrix of scatterplots colored by cluster." 
#| fig-scap: "Matrix of scatterplots colored by cluster."
#| layout-ncol: 1
# plot resulting clustering
pairs(sc_whr, col = km.out$cluster, upper.panel = NULL, gap = 0,
      text.panel = my.text.panel(c(happiness_score="Happiness Score",
                                   gdp_per_capita="GDP p. Capita",
                                   social_support="Social Support",
                                   healthy_life_expectancy="HL Expectancy",
                                   freedom_to_make_life_choices = "Freedom Life Choices",
                                   generosity = "Generosity",
                                   perceptions_of_corruption = "Perceived corruption")))
```

When looking at the scatter plots in @fig-k-means-plot, the first thing to be noted is that for happiness score, there is the cleanest split between the clusters which basically splits the plot into a happiness score that is bigger than 0 and vice versa. In other words, the clusters are strongly informed by whether the happiness score is in the upper 50% quantile or below.

```{r}
#| echo: false
sc_whr <- as.data.frame(sc_whr)
cat("Median of the happiness score:",median(sc_whr$happiness_score))
```

For further context, the median value of the happiness score is almost perfectly zero. From the initial plots it has been shown that the happiness score correlates with all variables plotted here except for generosity. We can see that all plots in the matrix show a similar pattern of a red cluster on the right and a black cluster on the left. The stronger the correlation between any variables, the less overlap the clusters appear to have. For GDP per capita and healthy life expectancy for example, the scatterplot shows a positive linear relationship between the two variables and the overlap is very little compared to generosity's interaction with freedom to make life choices, where most of the clusters overlap and no strong correlation exists.

# Using Random Forest to rank feature importance

When training a random forest on data, multiple trees are fitted on random subset of predictors in each iteration. The resulting plot provides two different types of variable importance which means how much a variable is contributing to improving the model.

```{r fig.width = 10}
#| echo: false
#| label: fig-randomforest
#| fig-cap: "Variable importance when predicting the happiness score with a random forest model." 
#| fig-scap: "Variable importance when predicting the happiness score with a random forest model."
#| layout-ncol: 1
# create a version of whr that contains all variables but no NAs
whr_noNA <- na.omit(whr)

# run randomforest on this data
set.seed(1)
rf.whr <- randomForest(happiness_score ~ ., data = whr_noNA, mtry = 3, ntree = 100,
                       importance = TRUE)
# mtry: amount of variables used for each iteration (floor(sqrt(n)) is rule of thumb)
# ntree: number of trees that are grown
# importance: is importance of predictors to be assessed or not

# plot importance of variables
varImpPlot(rf.whr, scale = FALSE, main = "Feature Importance for predicting Happiness Score")
```

The left plot in @fig-randomforest shows how much a variable contributes to decreasing the mean squared error of the resulting model. The mean squared error measures the difference between the true values and predictions. The variables are ordered by how much the variables increase the mean squared error when being left out. From this example, GDP per capita improves the tree by lowering the MSE the most and vice versa - when it is missing, the MSE is a lot higher. <br> Node Purity on the right side of @fig-randomforest represents how well the tree splits the data in similar target values. The more often variable is used for splitting a node in two further branches, the more important is the variable. In this plot GDP per capita again ranks highest, which means that it provides a useful condition on which to split groups. <br> When predicting the happiness score, GDP per capita and healthy life expectancy are ranked the highest for both importance measures. This coincides with the high correlations that have been measured for the scatter plots between happiness score and the two variables. <br> An important thing to keep in mind is that there is an element of randomness in these results. For different seeds, the top four variables are stable, but how important they are and their ranking can be different. It also should be noted at an increased MSE of 20% for example freedom to make life choices is still a strong impact, even if this variable appears of low rank compared to others.

# Discussion

There have been some consistent patterns over the different analysis that are worth being discussed. The connection between happiness and the geographical location, the relationship between happiness and perceived corruption and the role of generosity in this dataset are explored through research and evaluated.  <br>
The strongest pattern is that industrial countries reach higher happiness scores compared to developing countries (@fig-world-map). This pattern occurs for the top ranking of the happiness score and predictors where the top ranking countries all are industrial countries that also score highly on predictors that represent good living conditions like GDP per capita, social support, healthy life expectancy and freedom to make life choices (@fig-ranking1). When predicting the happiness score with a Random Forest model, the most important variables include the same predictors plus region (@fig-randomforest). This is consistent with research from the field of sociology, where feelings of happiness are connected to autonomy, good health, high economic development, strong social connections to family and friends and the fulfillment of basic needs (Veenhoven, 2001): this research also suggests factors that aren't covered by the World Happiness Report, for example the level of education, peacefulness, security and urbanization which are summarized under the term of modernity by the authors. Especially security and peace would be important predictors for explaining the happiness score in countries that find themselves in political conflict or even war, as it causes happiness to decline substantially (Coupe & Obrizan, 2016). <br>
Another pattern is that a variable that positively correlates with happiness is feelings of corruption. With 0.41 they correlate highly: Perception of corruption also has a highly positive linear relationship with freedom to make life choices, GDP per capita and healthy life expectancy, which where shown to strongly influence the happiness score (@fig-corr-mat). This seems contradictory when it has been shown that corruption has a negative impact on happiness (Li & An, 2020). However, it has also been shown that there is a mitigating effect of high per capita income in how negatively corruption is perceived (Arvin & Lew, 2014). This suggests that there might be a negative influence of perceptions of corruption on happiness but it gets outweighed by the high scores of the good living situation which bleed into the correlation between happiness and perceived corruption. The same pattern of perceived corruption correlating highly with high scores on variables that describe good living standards has also been found in other research (Anderson, 2016), showing that for improving happiness, perceived corruption might not have a strong negative influence. <br>
The third and last pattern to be discussed is generosity not being a strong predictor for happiness. It only has a weak correlation or with most variables except perception of corruption (@fig-corr-mat), has very different top ranking countries compared to other variables (@fig-ranking1) and for the Kmeans Clustering, the resulting clusters represent the relationship between generosity and other variables the worst (@fig-k-means-plot). When evaluating the importance of predictors for the happiness score through a Random Forest, generosity is shown to be negligible (@fig-randomforest). Research suggests that the relationship between income and generosity isn't straight forward: It's people in the middle income range who are shown to be most generous, while people with very high or very low income aren't as generous (Jones et al., 2007). Since most predictors in the World Happiness dataset are shown to have strong linear relationships with each over, it might be that this isn't the case for generosity and GDP per capita. GDP per capita might be the most important variable in this data to predict generosity as generosity is defined as donating money in the survey for the world happiness report. Other research suggests that there are external factors that influence charitable giving that aren't covered by the survey, such as personal benefits, future interests, trust and reward (Degasperi & Mainardes, 2017). Next to external factors, there are also internal factors such as attitudes toward helping others, attitudes towards a charitable organization among other social and economic motives (Green & Webb, 1997) which aren't further explained by the data set.

# Conclusion and Outlook

The analysis helped showing patterns in the world happiness data, that support effects found by previous research. Happiness is shown to be higher for developed countries which might be explained by the well met living conditions and overall wealth of these countries. Furthermore, countries that score highly on happiness also have positive linear relationship with perceptions of corruption which has also been found by other research. Even though corruption in itself might not improve happiness in itself, it might be a perceived trade-off for better living standards so that it is ultimately positively correlated with happiness. Lastly, generosity in the given sense of giving monetary donations has been shown to not have a strong connection to happiness or other variables that describe better living standards. It has been shown that for generosity a high living standard isn't necessarily a good predictor but instead other personal and external factors that aren't represented by the world happiness data set. Also it is shown that countries that rank highest on the generosity factors don't share countries with the ranking of the countries with the highest and lowest GDP per capita, hinting that the pattern found in research that people with a middle income are more likely to donate than rich or poor people. <br>
To further investigate effects, the happiness report provides further variables that capture the positive or negative effect from participant's life that might influence their answers on the survey. An interesting analysis would be to see whether these positive or negative influences significantly impact how participants answer survey questions. Furthermore there is a variable "dystopia" that is supposed to set a negative baselines to compare survey answers to. Further explorations on its methods and comparative effect might open more ways to understanding the context of differences of scores. To further explore the patterns mentioned, a meta analysis with research data that provides more context for variables could create more insights on how the survey's variables are impacted. Generosity requires more context the most as it doesn't have a strong relationship to any of the other variables to a degree where it's questionable whether generosity should be considered an explanatory variable to happiness at all.

# References

1.  World Happiness Report. *About*. Retrieved July 26, 2024, from <https://worldhappiness.report/about/>
2.  World Happiness Report. *World Happiness Report Appendices & Date*. Retrieved July 26, 2024 from <https://worldhappiness.report/data/>
3.  Wikipedia. (2024, July). *Gallup, Inc.* Retrieved July 27, 2024, from <https://en.wikipedia.org/wiki/Gallup,_Inc.#Gallup_World_Poll>
4.  World Happiness Report. (2024). *Happiness of the younger, the older, and those in between*. Retrieved July 27, 2024, from <https://worldhappiness.report/ed/2024/happiness-of-the-younger-the-older-and-those-in-between/#ranking-of-happiness-2021-2023>
5.  World Happiness Report. (2024). *World Happiness Report 2024 Figure 2.1: Country Rankings by Life Evaluations in 2021-2023*. Retrieved July 27, 2024, from <https://public.tableau.com/app/profile/worldhappiness/viz/2024Draft/Figure2_1>
6.  World Happiness Report. *FAQ*. Retrieved July 27, 2024, from <https://worldhappiness.report/faq/>
7.  World Happiness Report. (2024, March 12). *Appendix 1: Statistical Appendix for Chapter 2 of World Happiness Report 2024*. Retrieved July 26, 2024, from <https://happiness-report.s3.amazonaws.com/2024/Ch2+Appendix.pdf>
8.  Islam, S. (2023) *World Happiness Report up to 2023*. Retrieved July 1, 2024, from <https://www.kaggle.com/datasets/sazidthe1/global-happiness-scores-and-factors>
9. Veenhoven, R. (2001). Quality-of-Life and Happiness: not quite the same. Retrieved from <http://hdl.handle.net/1765/8753>
10. Coupe, T., Obrizan, M. (2016). The Impact of war on happiness: The case of Ukraine. Journal of Economic Behavior & Organization, Volume 132. 228 - 242. <https://doi.org/10.1016/j.jebo.2016.09.017>
11. Li, Q., An, L. (2020). Corruption Takes Away Happiness: Evidence from a Cross-National Study. Journal of Happiness Studies, Volume 21. 485 -  504. <https://doi.org/10.1007/s10902-019-00092-z>
12. Arvin, M., Lew, B. (2014). Does income matter in the happiness-corruption relationship?. Journal of Economic Studies. Volume 41. 469 - 490. <https://doi.org/10.1108/JES-02-2013-0024>
13. Anderson, T. (2016). A Global Examination of the Relationship Between Corruption and Well-Being and Happiness. Journal of Politics and Democratization, Volume 1(1). Retrieved from <https://jpd.gipa.ge/index.php/jpd/article/view/6891>
14. Jones, K., Doughty, A., & Hickson, M. (2006). The Effects of Age, Gender, and Economic Status on Generosity in the Presence of Exchange: A Pilot Study. Communication Quarterly, 54(2), 257–264. <https://doi.org/10.1080/01463370600650969>
15. Degasperi, N. C. (2017). What motivates money donation? A study on external motivators. Revista de Administração, Volume 52(4). 363-373. <https://doi.org/10.1016/j.rausp.2017.08.002>
16. Green, C. L., Webb, D. J. (1997). Factors Influencing Monetary Donations to Charitable Organizations. Journal of Nonprofit & Public Sector Marketing, Volume 5(3). 19-40. <https://doi.org/10.1300/J054v05n03_03>